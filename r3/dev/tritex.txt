| triangle with texture from r4 (PHREDA 2017)
| in progress..
| texture 1024*1024

##tritexture 0
##trizbuffer 0

#minx #maxx
#miny #maxy
#va0 #va1
#vb0 #vb1
#inv_p0z #inv_p1z #inv_p2z
#inv_p0u #inv_p1u #inv_p2u
#inv_p0v #inv_p1v #inv_p2v
#inv_Pz
#oiz #o0 #o1 #o2

:loop | xv0 yv0 y x -- xv0 yv0 y x
	pick3 over -	| va2
	pick3 pick3 -	| vb2

	va1 over * pick2 vb1 * -
	oiz * -? ( 3drop 4 a+ ; )
    'o2 !
	swap vb0 * swap va0 * -
	oiz * -? ( drop 4 a+ ; )
	'o1 !
	$1000000 o1 o2 + -
	-? ( drop 4 a+ ; )
	'o0 !

	o2 inv_p2z 22 *>>
	o1 inv_p1z 22 *>> +
	o0 inv_p0z 22 *>> +
	a> trizbuffer + @ <? ( drop 4 a+ ; )
	dup	a> trizbuffer + !

	'inv_Pz !
	|---- correct
	inv_p0u o0 22 *>>
	inv_p1u o1 22 *>> +
	inv_p2u o2 22 *>> +
	inv_Pz / $3ff and
	inv_p0v o0 22 *>>
	inv_p1v o1 22 *>> +
	inv_p2v o2 22 *>> +
	inv_Pz / $3ff and

	| u v
|	8 << | 256x256
	tritexture @ $ffff and | w image
	* 
	or
	1 + 2 << tritexture + @
	a!+
	;

::tritex | vert --
	dup @ over 16 + @ pick2 32 + @ | x0 x1 x2
	dup pick3 - 'va0 ! over pick3 - 'va1 !
	pick2 pick2 pick2
	min min
	sw >=? ( 4drop drop ; )
	clamp0 'minx !
	max max
	-? ( 2drop ; )
	sw clampMax 'maxx !
	dup 4+ @ over 20 + @ pick2 36 + @ | y0 y1 y2
	dup pick3 - 'vb0 ! over pick3 - 'vb1 !
	pick2 pick2 pick2
	min min
	sh >=? ( 4drop drop ; )
	clamp0 'miny !
	max max
	-? ( 2drop ; )
	sh clampMax 'maxy !

	va0 vb1 * va1 vb0 * - 0? ( 2drop ; )
	$1000000 swap / 'oiz !

	$1000000 over 8 + @ /
	over 12 + @ dup >r
	16 0>> over * 'inv_p0u !
	r> $ffff and over * 'inv_p0v !
	'inv_p0z !
	$1000000 over 24 + @ /
	over 28 + @ dup >r
	16 0>> over * 'inv_p1u !
	r> $ffff and over * 'inv_p1v !
	'inv_p1z !
	$1000000 over 40 + @ /
	over 44 + @ dup >r
	16 0>> over * 'inv_p2u !
	r> $ffff and over * 'inv_p2v !
	'inv_p2z !
	@+ swap @	| vx0 vy0
	minx miny setxy
	miny ( maxy <? 
		minx ( maxx <?
			loop
			1 + ) drop
		sw maxx minx - - 2 << a+
		1 + ) 3drop ;


|-------------------------
| x y z uv
#vertex2
189 183 40 $ff0000
200 100 120 $ff
60 160 100 $ff00ff

#vertex
549 424 3223281 $ff0000
156 232 3176603 $ff
365 226 3169984 $00

:dumpl
	@+ "x:%d " print
	@+ "y:%d " print
	@+ "z:%d " print
	@+ "c:%h " print
	cr
	;
:dump
	dumpl dumpl dumpl drop ;

:movz | cnt vert --
	8 + >a dup a> +!
	16 a+ dup a> +!
	a> 16 + +! ;


:drawl
	0 SDLclear
	
	'vertex2 dump

	xymouse swap 'vertex2 !+ !
	'vertex2 tritex

	SDLRedraw
	
	SDLkey
	>esc< =? ( exit )
		[ 10 'vertex2 movz ; ] <up>
		[ -10 'vertex2 movz ; ] <dn>
	
	drop ;
		
:main
	"r3sdl" 800 600 SDLinit
	
|	"media/obj/dragon.tga" loadtga 'texture !
	"media/obj/cube.png" loadpng 'tritexture !


	'drawl SDLshow 

	SDLquit
	;

: main ;

